<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji æ¶ç­”å¤§è³½ Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #6c5ce7; --accent: #fdcb6e; --danger: #ff7675; --success: #55efc4; --dark: #2d3436; }
        body { font-family: 'PingFang TC', sans-serif; background: radial-gradient(circle, #6c5ce7 0%, #4834d4 100%); color: white; margin: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .header-container { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .event-logo { width: 150px; height: 150px; object-fit: contain; }
        .event-title { font-size: 2.5rem; font-weight: 900; color: var(--accent); text-shadow: 3px 3px 0px #d35400; }
        .card { background: white; color: var(--dark); padding: 30px; border-radius: 30px; width: 90%; max-width: 500px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: center; position: relative; }
        .hidden { display: none !important; }
        .emoji-box { font-size: 80px; margin: 20px 0; min-height: 130px; display: flex; justify-content: center; align-items: center; background: #f1f2f6; border-radius: 20px; }
        input, select { padding: 12px; font-size: 1.1rem; width: 80%; margin: 10px 0; border: 3px solid #dfe6e9; border-radius: 12px; text-align: center; }
        button { background: var(--accent); color: #d35400; border: none; padding: 12px 25px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; font-weight: 900; box-shadow: 0 5px 0 #e67e22; margin: 10px; }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 #e67e22; }
        .host-fixed-tools { position: fixed; bottom: 15px; right: 15px; background: rgba(0, 0, 0, 0.85); padding: 15px; border-radius: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 1000; border: 1px solid rgba(255,255,255,0.2); }
        .btn-sm { font-size: 0.8rem; padding: 8px; margin: 0; }
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .lb-cell { padding: 12px 5px; font-size: 1.1rem; border-bottom: 1px solid #eee; }
        .top-1 { color: #f1c40f; font-size: 1.5rem; font-weight: bold; }
        /* é¡Œåº«ç®¡ç†æ¨£å¼ */
        #view-admin-qs { color: var(--dark); text-align: left; max-height: 70vh; overflow-y: auto; }
        .q-item { border-bottom: 1px solid #ddd; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="logo.png" alt="" class="event-logo" onerror="this.style.display='none'">
        <div class="event-title">æ´»å‹•åç¨±</div>
    </div>

    <div id="host-global-tools" class="host-fixed-tools hidden">
        <span style="font-size: 0.8rem; color: var(--accent);">ğŸ‘‘ ç®¡ç†å“¡æ§åˆ¶å°</span>
        <button onclick="goTo('view-admin-qs')" class="btn-sm" style="background: #a29bfe; color: #2d3436; box-shadow: 0 3px 0 #6c5ce7;">ğŸ“š é¡Œåº«ç¶­è­·</button>
        <button onclick="hardResetGame()" class="btn-sm" style="background: var(--danger); color: white; box-shadow: 0 3px 0 #c0392b;">ğŸ”„ é‡ç½®éŠæˆ²</button>
    </div>

    <div class="card">
        <div id="view-login">
            <h2 style="color: var(--primary);">æº–å‚™å¥½æ¶ç­”äº†å—ï¼Ÿ</h2>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å">
            <button id="btn-join">ä¸‹ä¸€é </button>
        </div>

        <div id="view-setup" class="hidden">
            <h2 style="color: var(--primary);">éŠæˆ²è¨­å®š</h2>
            <p>æ¬²æŠ½å–é¡Œæ•¸ï¼š</p>
            <input type="number" id="q-count" value="10">
            <button id="btn-to-instruction">å‰å¾€èªªæ˜é </button>
        </div>

        <div id="view-instruction" class="hidden">
            <h2 style="color: var(--primary);">éŠæˆ²èªªæ˜</h2>
            <div style="text-align: left; background: #f1f2f6; padding: 15px; border-radius: 15px; font-size: 0.9rem; color: #444;">
                ğŸ‘€ è¦å‰‡ï¼šåŒéŸ³å­—æ›¿æ›ï¼ˆå¦‚ï¼šğŸ‘€=è§€ï¼‰<br>
                ğŸ’¡ ç¯„ä¾‹ï¼šğŸ‘€ğŸµ â” <b>è§€éŸ³</b> | â¬‡ï¸ğŸ˜ï¸ â” <b>å—åº„</b>
            </div>
            <img src="qrcode.png" alt="QR Code" class="qr-code" style="width:180px; margin:15px auto; display:block;" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data='+encodeURIComponent(window.location.href.split('?')[0])">
            <div id="host-start-btn" class="hidden">
                <button id="btn-real-start" style="background:var(--success); color:#006266; box-shadow:0 5px 0 #009432;">ğŸ® é–‹å§‹éŠæˆ²</button>
            </div>
            <p id="wait-msg">ç­‰å¾…ä¸»æŒäººé–‹å§‹...</p>
        </div>

        <div id="view-game" class="hidden">
            <div id="q-header" style="font-weight:bold; color:var(--primary);"></div>
            <div id="q-emoji" class="emoji-box"></div>
            <div id="player-zone" class="hidden">
                <input type="text" id="ans-input" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ">
                <button id="btn-submit">é€å‡ºï¼</button>
                <p id="feedback" style="color:var(--danger); font-weight:bold;"></p>
            </div>
            <div id="win-notification" class="hidden">
                <div style="background:var(--success); color:#006266; padding:15px; border-radius:15px; font-weight:bold;">ğŸ‰ <span id="win-player-name"></span> ç­”å°äº†ï¼</div>
            </div>
            <div id="ans-reveal" class="hidden" style="background:#e1f5fe; padding:15px; border-radius:20px; margin-top:10px;">
                <h3 style="margin:0;">æ­£è§£ï¼š<span id="correct-ans" style="color:#0288d1;"></span></h3>
            </div>
            <div id="host-actions" class="hidden">
                <button id="btn-reveal">æ­æ›‰ç­”æ¡ˆ</button>
                <button id="btn-next" class="hidden" style="background:var(--primary); color:white;">ä¸‹ä¸€é¡Œ â”</button>
            </div>
        </div>

        <div id="view-result" class="hidden">
            <h2 style="color:var(--primary);">ğŸ† æ¦®è­½æ’è¡Œæ¦œ</h2>
            <table class="lb-table">
                <tbody id="leaderboard-body"></tbody>
            </table>
            <div id="host-reset-area" class="hidden">
                <button onclick="hardResetGame()" style="background:#dfe6e9; color:#636e72; margin-top:30px;">ğŸ”„ çµæŸä¸¦é‡ç½®</button>
            </div>
        </div>

        <div id="view-admin-qs" class="hidden">
            <h3 style="color: var(--primary);">ğŸ“š é¡Œåº«ç¶­è­·</h3>
            <div style="border: 2px solid #eee; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                <input type="text" id="new-q-emoji" placeholder="Emoji (ä¾‹: ğŸ²â™¨ï¸)" style="width:40%">
                <input type="text" id="new-q-ans" placeholder="ç­”æ¡ˆ (ä¾‹: é¾æ½­)" style="width:40%">
                <button onclick="addQuestion()" style="font-size:0.8rem; padding:5px 15px;">æ–°å¢</button>
            </div>
            <div id="qs-list">è¼‰å…¥é¡Œåº«ä¸­...</div>
            <button onclick="location.reload()" style="background:var(--dark); color:white; width:100%;">è¿”å›éŠæˆ²</button>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyAGKM7UL7hYCijHzS7lbPuHi-2M8Y9gZ7U",
            authDomain: "kahootclone-94620.firebaseapp.com",
            databaseURL: "https://kahootclone-94620-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kahootclone-94620",
            storageBucket: "kahootclone-94620.appspot.com",
            messagingSenderId: "173514871128",
            appId: "1:173514871128:web:6ca8ccb012ba5a49b7d52d"
        };
        firebase.initializeApp(config);
        const db = firebase.database();
        const isHost = window.location.search.includes('host=true');
        let myName = "";
        let localQuestions = [];

        function goTo(id) {
            document.querySelectorAll('.card > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function hardResetGame() {
            if(confirm("ç¢ºå®šé‡ç½®éŠæˆ²ä¸¦æ¸…ç©ºåˆ†æ•¸ï¼Ÿ")) {
                db.ref('game').remove();
                db.ref('players').remove();
                location.href = location.pathname + (isHost ? "?host=true" : "");
            }
        }

        // é¡Œåº«ç³»çµ±é‚è¼¯
        db.ref('questions').on('value', snap => {
            const data = snap.val();
            localQuestions = [];
            let html = "";
            for(let id in data) {
                localQuestions.push({id, ...data[id]});
                html += `<div class="q-item">
                    <span>${data[id].emoji} = ${data[id].answer}</span>
                    <button onclick="deleteQuestion('${id}')" class="btn-sm" style="background:var(--danger); color:white; box-shadow:none;">åˆªé™¤</button>
                </div>`;
            }
            document.getElementById('qs-list').innerHTML = html || "ç›®å‰ç„¡é¡Œç›®";
        });

        function addQuestion() {
            const emoji = document.getElementById('new-q-emoji').value;
            const answer = document.getElementById('new-q-ans').value;
            if(emoji && answer) {
                db.ref('questions').push({emoji, answer});
                document.getElementById('new-q-emoji').value = "";
                document.getElementById('new-q-ans').value = "";
            }
        }

        function deleteQuestion(id) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.ref('questions/' + id).remove(); }

        document.getElementById('btn-join').onclick = () => {
            myName = document.getElementById('username').value.trim();
            if(!myName) return alert("è«‹è¼¸å…¥å§“å");
            if(isHost) {
                document.getElementById('host-global-tools').classList.remove('hidden');
                goTo('view-setup');
            } else { goTo('view-instruction'); }
        };

        document.getElementById('btn-to-instruction').onclick = () => {
            goTo('view-instruction');
            if(isHost) document.getElementById('host-start-btn').classList.remove('hidden');
        };

        document.getElementById('btn-real-start').onclick = () => {
            if(localQuestions.length === 0) return alert("é¡Œåº«æ˜¯ç©ºçš„ï¼Œè«‹å…ˆå»ç¶­è­·é¡Œåº«æ–°å¢é¡Œç›®ï¼");
            const count = Math.min(parseInt(document.getElementById('q-count').value), localQuestions.length);
            const shuffled = localQuestions.sort(() => 0.5 - Math.random()).slice(0, count);
            db.ref('game').set({ status: 'playing', qs: shuffled, idx: 0, winner: "", show: false });
        };

        db.ref('game').on('value', snap => {
            const game = snap.val();
            if(!game) return;
            if(game.status === 'playing') {
                goTo('view-game');
                const cur = game.qs[game.idx];
                document.getElementById('q-emoji').innerText = cur.emoji;
                document.getElementById('q-header').innerText = `ç¬¬ ${game.idx + 1} é¡Œ / å…± ${game.qs.length} é¡Œ`;
                if(game.winner) {
                    document.getElementById('player-zone').classList.add('hidden');
                    document.getElementById('win-notification').classList.remove('hidden');
                    document.getElementById('win-player-name').innerText = game.winner;
                    if(isHost) {
                        document.getElementById('host-actions').classList.remove('hidden');
                        document.getElementById('btn-next').classList.toggle('hidden', !game.show);
                    }
                    if(game.show) {
                        document.getElementById('ans-reveal').classList.remove('hidden');
                        document.getElementById('correct-ans').innerText = cur.answer;
                    }
                } else {
                    if(!isHost) document.getElementById('player-zone').classList.remove('hidden');
                    document.getElementById('win-notification').classList.add('hidden');
                    document.getElementById('ans-reveal').classList.add('hidden');
                    document.getElementById('host-actions').classList.add('hidden');
                }
            } else if(game.status === 'finished') {
                goTo('view-result');
                if(isHost) document.getElementById('host-reset-area').classList.remove('hidden');
                db.ref('players').once('value', pSnap => {
                    const ps = pSnap.val();
                    let list = [];
                    for(let k in ps) list.push({n: k, s: ps[k]});
                    list.sort((a,b) => b.s - a.s);
                    let html = list.map((p, i) => `<tr><td class="lb-cell ${i==0?'top-1':''}">${i+1}</td><td class="lb-cell">${p.n}</td><td class="lb-cell">${p.s}</td></tr>`).join('');
                    document.getElementById('leaderboard-body').innerHTML = html;
                });
            }
        });

        document.getElementById('btn-submit').onclick = () => {
            const val = document.getElementById('ans-input').value.trim();
            db.ref('game').once('value', snap => {
                const g = snap.val();
                if(val === g.qs[g.idx].answer && !g.winner) {
                    db.ref('game/winner').set(myName);
                    db.ref('players/' + myName).transaction(s => (s || 0) + 10);
                } else if(val) document.getElementById('feedback').innerText = "âŒ ç­”éŒ¯äº†ï¼";
            });
        };

        document.getElementById('btn-reveal').onclick = () => db.ref('game/show').set(true);
        document.getElementById('btn-next').onclick = () => {
            db.ref('game').once('value', snap => {
                const g = snap.val();
                if(g.idx + 1 < g.qs.length) db.ref('game').update({idx: g.idx + 1, winner: "", show: false});
                else db.ref('game/status').set('finished');
            });
        };
    </script>
</body>
</html>