<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Emoji æ¶ç­”å¤§è³½ Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #6c5ce7; --accent: #fdcb6e; --danger: #ff7675; --success: #55efc4; --dark: #2d3436; }
        
        body { 
            font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
            background: radial-gradient(circle, #6c5ce7 0%, #4834d4 100%); 
            color: white; margin: 0; padding: 10px 0; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            touch-action: manipulation;
        }
        
        .header-container { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; width: 100%; }
        .event-logo { width: 150px; height: 150px; object-fit: contain; }
        
        /* æ¨™é¡Œè‡ªå‹•ç¸®æ”¾æ ¸å¿ƒ CSS */
        .event-title { 
            font-size: clamp(1.2rem, 5.5vw, 2.5rem); 
            font-weight: 900; 
            color: var(--accent); 
            text-shadow: 2px 2px 0px #d35400; 
            margin: 0; 
            white-space: nowrap; 
            width: 95%; 
            text-align: center;
        }
        
        .card { 
            background: white; color: var(--dark); padding: 20px; 
            border-radius: 25px; width: 88%; max-width: 450px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); text-align: center;
            position: relative; z-index: 10;
        }
        
        .hidden { display: none !important; }
        .instruction-box { text-align: left; background: #f1f2f6; padding: 20px; border-radius: 12px; color: #444; line-height: 1.8; margin-bottom: 15px; font-size: 1rem; }
        .emoji-box { font-size: 70px; margin: 15px 0; min-height: 120px; display: flex; justify-content: center; align-items: center; background: #f1f2f6; border-radius: 15px; }
        
        input, select { 
            padding: 15px; font-size: 1.1rem; width: 90%; margin: 10px 0; 
            border: 2px solid #dfe6e9; border-radius: 10px; text-align: center;
            appearance: none; -webkit-appearance: none;
        }
        
        button { 
            background: var(--accent); color: #d35400; border: none; 
            padding: 15px 25px; font-size: 1.1rem; border-radius: 50px; 
            cursor: pointer; font-weight: 900; box-shadow: 0 5px 0 #e67e22; 
            margin: 10px 5px; -webkit-tap-highlight-color: transparent;
        }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 #e67e22; }

        .host-fixed-tools { 
            position: fixed; bottom: 20px; right: 20px; 
            background: rgba(0, 0, 0, 0.95); padding: 15px; border-radius: 20px; 
            display: flex; flex-direction: column; gap: 10px; 
            z-index: 99999 !important; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-sm { font-size: 0.85rem; padding: 12px; margin: 0; min-width: 120px; box-shadow: 0 3px 0 #333; }
        
        .lb-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .lb-cell { padding: 12px 5px; font-size: 1rem; border-bottom: 1px solid #eee; }
        .top-1 { color: #f1c40f; font-size: 1.3rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-container">
        <img src="logo.png" alt="" class="event-logo" onerror="this.style.display='none'">
        <div class="event-title">114å¹´ç«¹è‹—DOC æœŸæœ«å·¥ä½œæœƒè­°</div>
    </div>

    <div id="host-global-tools" class="host-fixed-tools hidden">
        <span style="font-size: 0.8rem; color: var(--accent); text-align:center; font-weight:bold;">ğŸ‘‘ ç®¡ç†å“¡åŠŸèƒ½</span>
        <button id="btn-admin-qs" class="btn-sm" style="background: #a29bfe; color: #2d3436;">ğŸ“š é¡Œåº«ç¶­è­·</button>
        <button id="btn-hard-reset" class="btn-sm" style="background: var(--danger); color: white;">ğŸ”„ é‡ç½®éŠæˆ²</button>
    </div>

    <div class="card">
        <div id="view-login">
            <h2 id="login-title" style="color: var(--primary); margin-top: 0;">æº–å‚™å¥½æ¶ç­”äº†å—ï¼Ÿ</h2>
            <input type="text" id="username" placeholder="è«‹è¼¸å…¥å§“å">
            <button id="btn-join">ä¸‹ä¸€é </button>
        </div>

        <div id="view-setup" class="hidden">
            <h2 style="color: var(--primary);">éŠæˆ²è¨­å®š</h2>
            <p>æ¬²æŠ½å–é¡Œæ•¸ï¼š</p>
            <input type="number" id="q-count" value="10" inputmode="numeric">
            <button id="btn-to-instruction">å‰å¾€èªªæ˜é </button>
        </div>

        <div id="view-instruction" class="hidden">
            <h2 style="color: var(--primary);">éŠæˆ²èªªæ˜</h2>
            <div class="instruction-box">
                <b>éŠæˆ²èªªæ˜ï¼š</b><br>
                ğŸ‘€å¯èƒ½æ˜¯ã€Œçœ¼ã€ã€ã€Œç›ã€ã€ã€Œçœ‹ã€ã€ã€Œç›®ã€ã€ã€Œæœ›ã€...ç­‰çš„åŒéŸ³å­—ã€‚<br>
                ç¯„ä¾‹é¡Œç›®ï¼šğŸ‘€ğŸµ â” ç­”æ¡ˆï¼š<b>è§€éŸ³</b><br>
                ç¯„ä¾‹é¡Œç›®ï¼šâ¬‡ï¸ğŸ˜ï¸ â” ç­”æ¡ˆï¼š<b>å—åº„</b>
            </div>
            <img id="qr-display" src="qrcode.png" alt="QR Code" style="width:160px; margin:10px auto; display:block;" onerror="this.src='https://api.qrserver.com/v1/create-qr-code/?size=200x200&data='+encodeURIComponent(window.location.href.split('?')[0])">
            <div id="host-start-btn" class="hidden">
                <button id="btn-real-start" style="background:var(--success); color:#006266;">ğŸ® é–‹å§‹éŠæˆ²</button>
            </div>
            <p id="wait-msg">ç­‰å¾…ä¸»æŒäººé–‹å§‹...</p>
        </div>

        <div id="view-game" class="hidden">
            <div id="q-header" style="font-weight:bold; color:var(--primary);"></div>
            <div id="q-emoji" class="emoji-box"></div>
            <div id="player-zone" class="hidden">
                <input type="text" id="ans-input" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ" autocomplete="off">
                <button id="btn-submit">é€å‡ºï¼</button>
                <p id="feedback" style="color:var(--danger); font-weight:bold; min-height:1.2em;"></p>
            </div>
            <div id="win-notification" class="hidden">
                <div style="background:var(--success); color:#006266; padding:15px; border-radius:15px; font-weight:bold;">ğŸ‰ <span id="win-player-name"></span> æ¶åˆ°äº†ï¼</div>
            </div>
            <div id="ans-reveal" class="hidden" style="background:#e1f5fe; padding:15px; border-radius:20px; margin-top:10px;">
                <h3 style="margin:0;">æ­£è§£ï¼š<span id="correct-ans" style="color:#0288d1;"></span></h3>
            </div>
            <div id="host-actions" class="hidden">
                <button id="btn-reveal">æ­æ›‰ç­”æ¡ˆ</button>
                <button id="btn-next" class="hidden" style="background:var(--primary); color:white;">ä¸‹ä¸€é¡Œ â”</button>
            </div>
        </div>

        <div id="view-result" class="hidden">
            <h2 style="color:var(--primary);">ğŸ† æ¦®è­½æ’è¡Œæ¦œ</h2>
            <table class="lb-table"><tbody id="leaderboard-body"></tbody></table>
            <div id="host-reset-area" class="hidden">
                <button id="btn-finish-reset" style="background:#dfe6e9; color:#636e72; margin-top:20px;">ğŸ”„ çµæŸä¸¦é‡ç½®</button>
            </div>
        </div>

        <div id="view-admin-qs" class="hidden">
            <h3 style="color: var(--primary);">ğŸ“š é¡Œåº«ç¶­è­·</h3>
            <div style="border: 2px solid #eee; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                <input type="text" id="new-q-emoji" placeholder="Emoji">
                <input type="text" id="new-q-ans" placeholder="ç­”æ¡ˆ">
                <button id="btn-add-q" style="font-size:0.9rem; padding:10px;">æ–°å¢</button>
            </div>
            <div id="qs-list" style="max-height: 250px; overflow-y: auto; color: #2d3436; text-align: left;">è¼‰å…¥ä¸­...</div>
            <button id="btn-restore-qs" style="background: #95a5a6; color: white; width: 100%; font-size: 0.9rem; margin-top:10px;">â™»ï¸ æ¢å¾©é è¨­é¡Œåº« (34é¡Œ)</button>
            <button id="btn-back-game" style="background:var(--dark); color:white; width:100%;">è¿”å›</button>
        </div>
    </div>

    <script>
        const config = {
            apiKey: "AIzaSyAGKM7UL7hYCijHzS7lbPuHi-2M8Y9gZ7U",
            authDomain: "kahootclone-94620.firebaseapp.com",
            databaseURL: "https://kahootclone-94620-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kahootclone-94620",
            storageBucket: "kahootclone-94620.appspot.com",
            messagingSenderId: "173514871128",
            appId: "1:173514871128:web:6ca8ccb012ba5a49b7d52d"
        };
        firebase.initializeApp(config);
        const db = firebase.database();
        const isHost = window.location.search.includes('host=true');
        let myName = "";
        let localQuestions = [];

        if (isHost) {
            document.getElementById('host-global-tools').classList.remove('hidden');
            document.getElementById('login-title').innerText = "ğŸ”‘ ä¸»æŒäººç™»å…¥";
            document.getElementById('username').placeholder = "è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼";
        }

        const defaultQs = [
            { emoji: "ğŸ² â™¨ï¸", answer: "é¾æ½­" }, { emoji: "5ï¸âƒ£â›°ï¸", answer: "äº”å³°" }, { emoji: "ğŸ”Ÿ0ï¸âƒ£0ï¸âƒ£0ï¸âƒ£ğŸŒ¸", answer: "è¬è¯" },
            { emoji: "ğŸ¢â›°ï¸", answer: "é¾œå±±" }, { emoji: "ğŸ†•ğŸ ", answer: "æ–°å±‹" }, { emoji: "ğŸ†•ğŸ›’", answer: "æ–°åº—" },
            { emoji: "3ï¸âƒ£â›°ï¸", answer: "ä¸‰å³½" }, { emoji: "ğŸ¥‡â›°ï¸", answer: "é‡‘å±±" }, { emoji: "5ï¸âƒ£ğŸ¦´", answer: "äº”è‚¡" },
            { emoji: "7ï¸âƒ£ğŸš§", answer: "ä¸ƒå µ" }, { emoji: "ğŸ’â›°ï¸", answer: "å¯¶å±±" }, { emoji: "ğŸ¦ â™¨ï¸", answer: "ç…æ½­" },
            { emoji: "â¬‡ï¸âš“", answer: "å—æ¸¯" }, { emoji: "ğŸ˜ğŸ¤°", answer: "å¤§è‚š" }, { emoji: "ğŸ¦Œâš“", answer: "é¹¿æ¸¯" },
            { emoji: "2ï¸âƒ£ğŸŒ²", answer: "äºŒæ—" }, { emoji: "2ï¸âƒ£ğŸ’§", answer: "äºŒæ°´" }, { emoji: "ğŸ‹â›°ï¸", answer: "ç«¹å±±" },
            { emoji: "4ï¸âƒ£â™¨ï¸", answer: "å››æ¹–" }, { emoji: "ğŸ˜ğŸŒ²", answer: "å¤§æ—" }, { emoji: "ğŸ†•âš“", answer: "æ–°æ¸¯" },
            { emoji: "6ï¸âƒ£ğŸ¦µ", answer: "å…­è…³" }, { emoji: "ğŸ¦ŒğŸŒ±", answer: "é¹¿è‰" }, { emoji: "ğŸ§‚ğŸ’§", answer: "é¹½æ°´" },
            { emoji: "3ï¸âƒ£ğŸ§‘â€ğŸ¤â€ğŸ§‘", answer: "ä¸‰æ°‘" }, { emoji: "ğŸš©ğŸ–Œï¸", answer: "æ——å±±" }, { emoji: "6ï¸âƒ£ğŸ¢", answer: "å…­é¾œ" },
            { emoji: "â¡ï¸âš“", answer: "æ±æ¸¯" }, { emoji: "â™¾ï¸ğŸŒ¸", answer: "æ†æ˜¥" }, { emoji: "ğŸ¦", answer: "ç…å­" },
            { emoji: "ğŸŒº", answer: "ç‰¡ä¸¹" }, { emoji: "3ï¸âƒ£â­", answer: "ä¸‰æ˜Ÿ" }, { emoji: "ğŸ˜âš”ï¸", answer: "å¤§æ­¦" },
            { emoji: "7ï¸âƒ£ ğŸ§œ", answer: "ä¸ƒç¾" }
        ];

        function goTo(id) {
            document.querySelectorAll('.card > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function bind(id, fn) {
            const el = document.getElementById(id);
            if(el) el.onclick = (e) => { e.preventDefault(); fn(e); };
        }

        db.ref('questions').on('value', snap => {
            const data = snap.val();
            if(!data && isHost) { defaultQs.forEach(q => db.ref('questions').push(q)); return; }
            localQuestions = [];
            let html = "";
            for(let id in data) {
                localQuestions.push({id, ...data[id]});
                html += `<div style="border-bottom:1px solid #ddd; padding:8px 0; display:flex; justify-content:space-between; align-items:center;">
                    <span>${data[id].emoji} = ${data[id].answer}</span>
                    <button onclick="deleteQuestion('${id}')" style="background:var(--danger); color:white; padding:5px 10px; font-size:0.7rem; box-shadow:none; margin:0;">åˆªé™¤</button>
                </div>`;
            }
            document.getElementById('qs-list').innerHTML = html || "ç›®å‰ç„¡é¡Œç›®";
        });

        window.deleteQuestion = (id) => { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.ref('questions/'+id).remove(); };

        bind('btn-join', () => {
            const userInput = document.getElementById('username').value.trim();
            if(!userInput) return alert("è«‹è¼¸å…¥å…§å®¹");
            if(isHost) {
                if(userInput === "00000") { myName = "ç®¡ç†å“¡"; goTo('view-setup'); } 
                else { alert("ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤ï¼"); }
            } else {
                myName = userInput; goTo('view-instruction');
            }
        });

        bind('btn-to-instruction', () => {
            goTo('view-instruction');
            if(isHost) document.getElementById('host-start-btn').classList.remove('hidden');
        });

        bind('btn-real-start', () => {
            const count = Math.min(parseInt(document.getElementById('q-count').value), localQuestions.length);
            const shuffled = localQuestions.sort(() => 0.5 - Math.random()).slice(0, count);
            db.ref('game').set({ status: 'playing', qs: shuffled, idx: 0, winner: "", show: false });
        });

        bind('btn-submit', () => {
            const val = document.getElementById('ans-input').value.trim();
            if(!val) return;
            db.ref('game').once('value', snap => {
                const g = snap.val();
                if(!g || g.winner) return;
                if(val === g.qs[g.idx].answer) {
                    db.ref('game/winner').set(myName);
                    db.ref('players/' + myName).transaction(s => (s || 0) + 10);
                } else {
                    document.getElementById('feedback').innerText = "âŒ ç­”éŒ¯äº†ï¼";
                    setTimeout(() => document.getElementById('feedback').innerText = "", 1500);
                }
            });
        });

        bind('btn-reveal', () => db.ref('game/show').set(true));
        bind('btn-next', () => {
            db.ref('game').once('value', snap => {
                const g = snap.val();
                if(g.idx + 1 < g.qs.length) db.ref('game').update({idx: g.idx + 1, winner: "", show: false});
                else db.ref('game/status').set('finished');
            });
        });

        bind('btn-admin-qs', () => goTo('view-admin-qs'));
        bind('btn-hard-reset', () => { if(confirm("ç¢ºå®šé‡ç½®éŠæˆ²ï¼Ÿ")) { db.ref('game').remove(); db.ref('players').remove(); location.reload(); } });
        bind('btn-finish-reset', () => { db.ref('game').remove(); db.ref('players').remove(); location.reload(); });
        bind('btn-back-game', () => location.reload());
        
        bind('btn-restore-qs', () => {
            if(confirm("æ¢å¾©34é¡Œé è¨­ï¼Ÿ")) {
                db.ref('questions').remove().then(() => {
                    defaultQs.forEach(q => db.ref('questions').push(q));
                    alert("å·²æ¢å¾©");
                });
            }
        });
        
        bind('btn-add-q', () => {
            const emoji = document.getElementById('new-q-emoji').value;
            const answer = document.getElementById('new-q-ans').value;
            if(emoji && answer) {
                db.ref('questions').push({emoji, answer});
                document.getElementById('new-q-emoji').value = "";
                document.getElementById('new-q-ans').value = "";
            }
        });

        db.ref('game').on('value', snap => {
            const game = snap.val();
            if(!game) return;
            if(game.status === 'playing') {
                goTo('view-game');
                const cur = game.qs[game.idx];
                document.getElementById('q-emoji').innerText = cur.emoji;
                document.getElementById('q-header').innerText = `ç¬¬ ${game.idx + 1} é¡Œ / å…± ${game.qs.length} é¡Œ`;
                if(game.winner) {
                    document.getElementById('player-zone').classList.add('hidden');
                    document.getElementById('win-notification').classList.remove('hidden');
                    document.getElementById('win-player-name').innerText = game.winner;
                    if(isHost) {
                        document.getElementById('host-actions').classList.remove('hidden');
                        document.getElementById('btn-next').classList.toggle('hidden', !game.show);
                    }
                    if(game.show) {
                        document.getElementById('ans-reveal').classList.remove('hidden');
                        document.getElementById('correct-ans').innerText = cur.answer;
                    }
                } else {
                    if(!isHost) document.getElementById('player-zone').classList.remove('hidden');
                    document.getElementById('win-notification').classList.add('hidden');
                    document.getElementById('ans-reveal').classList.add('hidden');
                    document.getElementById('host-actions').classList.add('hidden');
                    document.getElementById('ans-input').value = "";
                }
            } else if(game.status === 'finished') {
                goTo('view-result');
                if(isHost) document.getElementById('host-reset-area').classList.remove('hidden');
                db.ref('players').once('value', pSnap => {
                    const ps = pSnap.val();
                    let list = [];
                    for(let k in ps) list.push({n: k, s: ps[k]});
                    list.sort((a,b) => b.s - a.s);
                    document.getElementById('leaderboard-body').innerHTML = list.map((p, i) => `<tr><td class="lb-cell ${i==0?'top-1':''}">${i+1}</td><td class="lb-cell">${p.n}</td><td class="lb-cell">${p.s}</td></tr>`).join('');
                });
            }
        });
    </script>
</body>
</html>